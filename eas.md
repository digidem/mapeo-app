# Expo App Services Documentation

### General Architecture

Expo App Services builds the app using expo build services in the cloud through the EAS CLI.

The build configuration can be found in the eas.json file.

The app.json file indicates that the build is to be done through Digital Democracy's account.

<!-- Eas comes with [Build lifecycle hooks](https://docs.expo.dev/build-reference/npm-hooks/). Using the `eas-build-post-install` hook, translations are built.... -->

### eas.json file:

Info on configuring the `eas.json` can be found [here](https://docs.expo.dev/build/eas-json/)

```json
{
  "cli": {
    "version": ">= 0.60.0"
  },

  "build": {
    // base is used as a universal property that is extended into the other build files
    "base": {
      "android": {
        // https://docs.expo.dev/build-reference/infrastructure/#android-build-server-configurations
        // we are using this version because we know jdk 8 works
        "image": "ubuntu-20.04-jdk-8-ndk-r21e"
      }
    },
    "development": {
      "extends": "base",
      "distribution": "internal",
      "android": {
        "withoutCredentials": true,
        // This gradle command builds the devolopment build
        "gradleCommand": ":app:assembleDebug"
      },
      "ios": {
        "buildConfiguration": "Debug"
      }
    },
    "qa": {
      "extends": "base",
      "distribution": "internal",
      /** expo app service will be default create an .aab file. This .aab file will
       * create the appropriate release for app store and play store. In our case
       * we want to build several different releases (not an .aab file). As well we only want to compile
       * the backend once (each variant has the same backend end, different front end)
       * this is what this gradeCommand is for
       */
      "android": {
        "gradleCommand": "assembleAppRelease assembleIccaRelease assembleQaRelease -x bundleAppReleaseJsAndAssets -x bundleIccaReleaseJsAndAssets -x bundleQaReleaseJsAndAssets"
      }
    },
    "release": {
      "extends": "base",
      "distribution": "internal",
      "android": {
        "gradleCommand": "assembleAppRelease assembleAppIntel assembleAppUniversal assembleIccaRelease assembleQaRelease -x bundleAppReleaseJsAndAssets -x bundleAppIntelJsAndAssets -x bundleAppUniversalJsAndAssets -x bundleIccaReleaseJsAndAssets -x bundleQaReleaseJsAndAssets"
      }
    }
  },
  "submit": {
    "production": {}
  }
}
```

### Versioning:

Currently we have 3 types of APK releases, each with their own version name format:

- Production Releases: Standard semver e.g. {major}.{minor}.{patch}.

- Release Candidates: {major}.{minor}.{patch}-RC+{sha7}. Here {major}.{minor}.{patch} refers to the pending release. sha7 is the Git commit sha used for the build, shortened to 7 characters.
- Internal test builds: {major}.{minor}.{patch}-PR{pullRequestNumber}+{sha7}+{buildNumber} where pullRequestNumber is the number of the PR that the build is built from, sha7 as above. And buildNumber is the number generated by Expo Application Services Here {major}.{minor}.{patch} would be most recently published production version that has been merged back into the develop branch.

The version name is set through the eas.json file and github actions.

The eas.json file has [env variables](https://docs.expo.dev/build-reference/variables/) that are available to expo build service. By setting the env variable `ANDROID_VERSION_NAME` to the appropriate version name, expo build service can use this variable to approriatle name the APK. Since the eas.json is a static file, a script is used to temporarily rewrite the eas.json file. This rewrite is activated with a github action (ADD DETAILS FOR GITHUB ACTION HERE). [set-android-version-name.js](scripts/set-android-version-name.js) is the script used to temoprarily rewrite eas.json file with the approriate version name.
